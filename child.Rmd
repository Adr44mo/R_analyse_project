---
title: "test"
author: "moi"
date: "2025-04-02"
output: html_document
---

---
title: "Projet"
author: "moi"
date: "2025-02-28"
output: html_document
keep_md: true
---

```{r, echo=FALSE, results='hide', message=FALSE, warning=FALSE}
#rmarkdown::render("Projet.Rmd", output_format = "pdf_document")
#rmarkdown::render("Projet.Rmd", output_format = "html_document")
```

# Projet : Analyse de données financières

## 1. Introduction

### Présentation du jeu de données : "Market Cap"

Ce jeu de données contient des informations sur les plus grandes entreprises mondiales en termes de capitalisation boursière. Il inclut diverses variables financières et ESG (Environnement, Social et Gouvernance) qui permettent d’analyser leur performance économique et leur engagement en matière de durabilité.

#### Structure du jeu de données

-   **Nombre de variables** : 45\
-   **Types de variables** :
    -   **Quantitatives** : marketCap (capitalisation boursière), trailingPE (PER historique), forwardPE (PER futur), priceToBook (prix/valeur comptable), totalEsg (score ESG), etc.\
    -   **Qualitatives** : sector (secteur d’activité), country (pays), peerGroup (groupe de pairs), esgPerformance (performance ESG), etc. Vous pouvez retrouver la description de chacune des variables dans l’annexe.

#### Problématiques soulevées

1.  **Analyse de la capitalisation boursière**
    -   Quels sont les secteurs les plus représentés parmi les entreprises ayant la plus grande capitalisation boursière ?\
    -   Existe-t-il une corrélation entre la capitalisation et d’autres variables financières (PER, price-to-book, etc.) ?
2.  **Performances ESG et responsabilité sociale**
    -   Quel est l’impact des scores ESG sur la valorisation des entreprises ?\
    -   Les entreprises ayant une forte capitalisation boursière ont-elles tendance à avoir de meilleures performances ESG ?
3.  **Comparaisons sectorielles et géographiques**
    -   Quels sont les pays qui dominent le classement des entreprises à forte capitalisation ?\
    -   Comment les secteurs d’activité diffèrent-ils en termes de ratios financiers et d’engagement ESG ?
4.  **Analyse prédictive et tendances**
    -   Peut-on prédire la performance future d’une entreprise en fonction de ses indicateurs financiers et ESG ?\
    -   Existe-t-il des anomalies statistiques qui mériteraient une étude plus approfondie ?

```{r, echo=FALSE, results='hide'}
# Charger la librairie nécessaire
library(tidyverse)

# 1. Charger le fichier CSV
load_marketcap_data <- function() {
  file_path <- "Morille_Adrien_Malleret_Antoine_yahoo_finance.csv"  # Mets ici le chemin complet si nécessaire
  df_marketcap <- read.csv(file_path)
  return(df_marketcap)
}

# 2. Filtrer les lignes de 0 à 1500
filter_data <- function(df_marketcap) {
  filtered_data <- df_marketcap[1:1500, ]
  return(filtered_data)
}

# 3. Enregistrer le résultat dans un nouveau fichier CSV
save_to_csv <- function(filtered_data) {
  write.csv(filtered_data, "marketcap_0_1500.csv", row.names = FALSE)
}

# 4. Fonction principale

# Charger le fichier CSV
df_marketcap <- load_marketcap_data()
  
# Filtrer les lignes
filtered_data <- filter_data(df_marketcap)
  
# Sauvegarder dans un nouveau CSV
save_to_csv(filtered_data)



```

Netoyage des donées.

```{r, echo=FALSE, results='hide'}
# Charger la librairie nécessaire
library(tidyverse)

# 1. Charger le fichier CSV
file_path <- "marketcap_0_1500.csv"  # Mets ici le chemin complet si nécessaire
df <- read.csv(file_path)

# Aperçu des premières lignes du fichier chargé
head(df)

# 2. Supprimer les lignes vides
# Utilisation de drop_na() pour supprimer toutes les lignes contenant des NA
cleaned_data <- df %>% drop_na()
# supprimer les ligne avec des données manquantes
cleaned_data <- na.omit(df)
# supprimer les lignes avec des N/A
cleaned_data <- df[complete.cases(df),]
cleaned_data[cleaned_data == ""] <- NA
cleaned_data <- na.omit(cleaned_data)

# Vérifier le nombre de lignes avant et après le nettoyage
cat("Nombre de lignes avant nettoyage :", nrow(df), "\n")
cat("Nombre de lignes après nettoyage :", nrow(cleaned_data), "\n")

# 3. Enregistrer le résultat nettoyé dans un nouveau fichier CSV
write.csv(cleaned_data, "marketcap_cleaned.csv", row.names = FALSE)
cat("✅ Fichier 'marketcap_cleaned.csv' sauvegardé avec succès !\n")

# 5 supprimer les colonnes inutiles
# Définir Name comme nom de ligne et le supprimer du dataset
rownames(cleaned_data) <- cleaned_data$Name
cleaned_data$Name <- NULL
cleaned_data$Symbol <- NULL
cleaned_data$Rank <- NULL
cleaned_data$maxAge <- NULL
cleaned_data$ratingYear <- NULL
cleaned_data$ratingMonth <- NULL

# 5. Afficher les premières lignes du tableau nettoyé
head(cleaned_data)
```

Conversion des données en numérique.

```{r, echo=FALSE, results='hide'}
# Vérifier les types des colonnes
str(cleaned_data)

# Identifier les colonnes quantitatives à convertir
quantitative_columns <- c("marketCap", "previousClose", "trailingPE", "forwardPE", 
                          "priceToBook", "beta", "profitMargins", "enterpriseToRevenue", 
                          "enterpriseToEbitda", "totalRevenue", "revenuePerShare", 
                          "revenueGrowth", "grossMargins", "ebitdaMargins", "operatingMargins", 
                          "returnOnAssets", "returnOnEquity", "debtToEquity", "currentRatio", 
                          "quickRatio", "totalCash", "totalDebt", "bookValue", 
                          "fiveYearAvgDividendYield", "payoutRatio", 
                          "trailingAnnualDividendYield", "trailingAnnualDividendRate", 
                          "totalEsg", "environmentScore", "socialScore", "governanceScore")

# Convertir ces colonnes en numeric
cleaned_data[quantitative_columns] <- lapply(cleaned_data[quantitative_columns], function(x) {
  # Enlever les caractères non numériques comme les symboles monétaires, et les convertir en numeric
  as.numeric(gsub("[^0-9.-]", "", x))
})



# Vérifier les types après conversion
str(cleaned_data)
```

## Analyse exploratoire des données

```{r, echo=FALSE}
# test les différent pays et donnée le nombre d'entreprise par pays
df <- cleaned_data
# Nombre d'entreprises par pays
df %>%
  group_by(country) %>%
  summarise(Count = n()) %>%
  arrange(desc(Count))

df %>%
  group_by(country) %>%
  summarise(Count = n()) %>%
  arrange(desc(Count)) %>%
  ggplot(aes(x = reorder(country, Count), y = Count, fill = country)) +
  geom_bar(stat = "identity") +
  coord_flip() +
  labs(title = "Nombre d'entreprises par pays", x = "Pays", y = "Nombre d'entreprises") +
  theme_minimal()
```

### 1. Corrélation entre la Marge Bénéficiaire et le Ratio d'Endettement

Un scatter plot est pertinent pour analyser la relation entre deux variables financières, comme *profitMargins* et *debtToEquity*, afin de visualiser s'il existe une corrélation entre la rentabilité et l'endettement.

```{r, echo=FALSE}
library(ggplot2)

ggplot(cleaned_data, aes(x = debtToEquity, y = profitMargins)) +
  geom_point(color = "purple", alpha = 0.6) +
  labs(title = "Relation entre Marge Bénéficiaire et Ratio d'Endettement",
       x = "Ratio d'Endettement (Debt to Equity)",
       y = "Marge Bénéficiaire (%)") +
  theme_minimal()
```

### 2. Distribution de la Capitalisation Boursière par Secteur

Un boxplot est un excellent moyen de visualiser la distribution de la capitalisation boursière par secteur, ce qui permet de comparer la taille des entreprises dans différents domaines d'activité.

```{r, echo=FALSE}
ggplot(cleaned_data, aes(x = sector, y = marketCap, fill = sector)) +
  geom_boxplot() +
  labs(title = "Distribution de la Capitalisation Boursière par Secteur",
       x = "Secteur d'Activité",
       y = "Capitalisation Boursière (en milliards USD)") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

### 3. Scores ESG par Continent

Un diagramme en violon pourrait être intéressant pour analyser la distribution des scores ESG (*totalEsg*) en fonction des continents. Cela permettrait de visualiser les écarts dans la performance ESG en fonction de la région géographique.

```{r, echo=FALSE}
ggplot(cleaned_data, aes(x = Continent, y = totalEsg, fill = Continent)) +
  geom_violin(trim = FALSE) +
  labs(title = "Distribution des Scores ESG par Continent",
       x = "Continent",
       y = "Score ESG Total") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

### 4. Comparaison de la Rentabilité (ROA vs ROE)

Un graphique en nuage de points est une bonne manière de comparer les deux indicateurs financiers, à savoir le Return on Assets (ROA) et le Return on Equity (ROE), pour chaque entreprise.

```{r, echo=FALSE}
ggplot(cleaned_data, aes(x = returnOnAssets, y = returnOnEquity)) +
  geom_point(color = "blue", alpha = 0.6) +
  labs(title = "Comparaison de la Rentabilité des Actifs (ROA) et des Fonds Propres (ROE)",
       x = "Rentabilité des Actifs (ROA)",
       y = "Rentabilité des Fonds Propres (ROE)") +
  theme_minimal()
```

## ACP : Analyse en Composantes Principales

```{r, echo=FALSE}
library(ggplot2)
library(FactoMineR)  # Pour l'ACP

# Copier le dataset nettoyé
clean_data <- cleaned_data

# Assigner les noms d'entreprises aux rownames et supprimer la colonne Name
rownames(clean_data) <- clean_data$Name
clean_data$Name <- NULL

# On garde toutes les données sans filtrer sur top_50 cette fois

# On identifie toutes les colonnes quantitatives pour l'ACP
quantitative_columns <- c("marketCap", "previousClose", "trailingPE", "forwardPE", 
                          "priceToBook", "beta", "profitMargins", "enterpriseToRevenue", 
                          "enterpriseToEbitda", "totalRevenue", "revenuePerShare", 
                          "revenueGrowth", "grossMargins", "ebitdaMargins", "operatingMargins", 
                          "returnOnAssets", "returnOnEquity", "debtToEquity", "currentRatio", 
                          "quickRatio", "totalCash", "totalDebt", "bookValue", 
                          "fiveYearAvgDividendYield", "payoutRatio", 
                          "trailingAnnualDividendYield", "trailingAnnualDividendRate", 
                          "totalEsg", "environmentScore", "socialScore", "governanceScore")

# Sélection des variables quantitatives + les variables qualitatives pour habillage
data_perf <- clean_data[, c(quantitative_columns, "sector", "Index")]

# Effectuer l'ACP avec variables qualitatives en quali.sup
res_pca <- PCA(data_perf, graph = TRUE, scale.unit = TRUE, ncp = 5, quali.sup = c((length(quantitative_columns) + 1), (length(quantitative_columns) + 2)))

# Afficher les valeurs propres
print(res_pca$eig)
```

Analyse en Composantes Principales (ACP) 1️⃣ Variance expliquée par les axes

```{r}
# Résumé des valeurs propres
print(res_pca$eig)
```

Observations :

Dim 1 : environ 10 % de variance expliquée. Dim 2 : +9 %, cumul 19 %. Dim 3 : +8 %, cumul 27 %. Dim 4 : +6.6 %, cumul 33 %. Dim 5 : +6.4 %, cumul 40 %. Conclusion : Les 5 premiers axes expliquent environ 40 % de l’inertie totale.

2️⃣ Contributions des variables par axe

```{r}
# Contributions des variables
print(res_pca$var$contrib)
```

📊 Axe 1 (Dim.1) Variables dominantes :

priceToBook, enterpriseToRevenue, enterpriseToEbitda (≈ 98 %) Interprétation : Axe lié à la valorisation (ratios financiers).

📊 Axe 2 (Dim.2) Variables dominantes :

totalRevenue (48 %) totalCash (55 %) grossMargins, ebitdaMargins, governanceScore Interprétation : Axe de solidité financière et rentabilité.

📊 Axe 3 (Dim.3) Variables dominantes :

totalEsg, socialScore, ebitdaMargins Interprétation : Axe ESG et efficacité opérationnelle.

📊 Axe 4 (Dim.4) Variables dominantes :

currentRatio & quickRatio (\> 63 %) Interprétation : Axe des liquidités (santé à court terme).

📊 Axe 5 (Dim.5) Variables dominantes :

trailingAnnualDividendYield & trailingAnnualDividendRate (\> 97 %) Interprétation : Axe purement lié au dividende.

4️⃣ Graphiques de l'ACP Graphique individus (habillage par Index)

```{r}
plot(res_pca, habillage = (length(quantitative_columns) + 2), select = "cos2 0.8", choix = "ind")
```

✅ Conclusion Cette ACP permet de bien visualiser :

L’opposition entre valorisation, marges et politique de dividende. L’impact de l’ESG dans la structure multidimensionnelle. La répartition hétérogène des entreprises selon leur secteur et leur Index. Ce jeu de données est idéal pour une analyse multidimensionnelle incluant des méthodes comme l’ACP (Analyse en Composantes Principales), la régression linéaire et l’ANOVA.

## 2. Importation et prétraitement des données

Voir annex pour plus de détails sur les variables du jeu de données et le code utilisée.

```{r, echo=FALSE}
#ACP sur l'esg
data_esg <- cleaned_data[, c("totalEsg", "environmentScore", "socialScore", "governanceScore","esgPerformance","sector")]

res_pca_esg <- PCA(data_esg, graph = T,scale.unit = TRUE, ncp = 5, quali.sup = c(5,6))
res_pca_esg$eig
plot(res_pca_esg, habillage = 5, select = "cos2 0.8",choix = c("ind"))
plot(res_pca_esg, habillage = 6, select = "cos2 0.95",choix = c("ind"))

```

# Classification non supervisée

📌 1. Préparation des données On prépare les données en supprimant les variables inutiles et en s’assurant que les variables qualitatives sont bien en facteur.

```{r}
library(FactoMineR)
library(cluster)

# Charger les données nettoyées
data <- cleaned_data

# Suppression des colonnes non utiles (nom, symbole, index, etc.)
data <- data %>% select(-c(Continent))

# Convertir les variables qualitatives en facteur
data$sector <- as.factor(data$sector)
data$country <- as.factor(data$country)
data$esgPerformance <- as.factor(data$esgPerformance)

# Vérification des NA et nettoyage
data <- na.omit(data)
```

📌 2. Analyse Factorielle des Données Mixtes (FAMD) On utilise FAMD (Analyse Factorielle des Données Mixtes) pour gérer variables quantitatives et qualitatives.

```{r}
# FAMD sur les données
res_famd <- FAMD(data, graph = TRUE, ncp = 5)
```

```{r}
# Cercle des corrélations
plot(res_famd, choix = "quanti")

# Graphique des individus
plot(res_famd, choix = "ind")

# changer les dimensions
plot(res_famd, choix = "ind", axes = c(1,3),cos2 = 0.8)
```

📌 3. Clustering avec k-means sur les premières composantes On applique k-means pour regrouper les entreprises.

```{r}
# Afficher la variance expliquée par dimension
print(res_famd$eig)

# Calculer la variance cumulée
variance_cumulee <- cumsum(res_famd$eig[, 2])
print(variance_cumulee)

```

```{r}
# Sélection des 5 premières dimensions
coord <- res_famd$ind$coord[, 1:5]

# Choix du nombre de clusters (méthode de l'inertie)
inertie.intra <- rep(0, 10)
for (k in 1:20) {
  kmeans_res <- kmeans(coord, centers = k, nstart = 100)
  inertie.intra[k] <- kmeans_res$tot.withinss / kmeans_res$totss
}

# Affichage du graphique pour choisir le bon nombre de clusters
plot(1:20, inertie.intra, type = "b", xlab = "Nb. de groupes", ylab = "% inertie intra")

# On choisit 3 groupes ici (à ajuster selon le graphique)
kmeans_result <- kmeans(coord, centers = 3, nstart = 100)

# Ajout des clusters aux données
data_cluster <- cbind.data.frame(data, cluster = factor(kmeans_result$cluster))

# observer les clusters
table(data_cluster$cluster)


```

📌 4. Classification Hiérarchique (CAH) avec HCPC On applique la Classification Ascendante Hiérarchique (CAH) pour vérifier si les groupes sont cohérents.

```{r}
# Lancer la CAH sur les résultats de FAMD
cah_res <- HCPC(res_famd, nb.clust = -1, graph = TRUE)
```

📌 5. Interprétation des clusters On analyse les groupes obtenus.

```{r}
table(data_cluster$cluster)

# Moyennes des variables par cluster
aggregate(data_cluster, by = list(data_cluster$cluster), FUN = mean)


```

```{r}

# Contribution des variables aux axes, du plus au moins impactant
# Boucle sur toutes les dimensions
for (i in 1:ncol(res_famd$var$contrib)) {
  cat("\nDimension", i, ":\n")
  
  # Trier les contributions des variables pour la dimension i
  contributions <- sort(res_famd$var$contrib[, i], decreasing = TRUE)
  
  # Afficher les 5 premières variables les plus influentes
  print(head(contributions, 5))
}


```

🔹 Interprétation des dimensions 

1.Dimension 1 (Axe principal - Facteurs financiers)

- Regroupe des variables économiques et financières clés (revenus, dividendes, valeur comptable).

- Représente la solidité financière et la performance économique d’une entreprise.

- Une forte valeur sur cet axe indique une entreprise avec une capitalisation boursière élevée et de bons résultats financiers.

2.Dimension 2 (Facteurs ESG et environnementaux)

- Met en avant les scores ESG (Environnement, Social, Gouvernance) et le secteur d'activité.

- Représente l'engagement des entreprises envers les pratiques durables et responsables.

- Une entreprise avec un score élevé ici est bien notée sur les critères ESG et est dans un secteur où ces aspects sont valorisés.

3.Dimension 3 (Marge et rentabilité sectorielle)

- Regroupe des indicateurs de rentabilité comme l'EBITDA, les marges opérationnelles et le secteur.

- Indique la capacité d’une entreprise à générer des profits par rapport à son secteur.

- Une valeur élevée ici correspond à une entreprise très rentable dans son industrie.

4.Dimension 4 (Retour sur actifs et rendement des investissements)

- Focalise sur le retour sur actifs (ROA), le rendement sur investissements et l’appartenance à un groupe sectoriel.

- Met en évidence les entreprises qui utilisent efficacement leurs ressources pour générer des profits.

- Une valeur forte ici suggère une excellente gestion des actifs et un bon retour sur investissement.

5.Dimension 5 (Santé financière et liquidité)

- Associe le secteur, la liquidité (current ratio, quick ratio) et le pays.

- Capture la capacité d’une entreprise à faire face à ses obligations financières à court terme.

- Une valeur élevée indique une entreprise avec une bonne gestion de sa trésorerie et un faible risque de liquidité.

# Annexe : Explication des variables du jeu de données

Ce jeu de données contient des informations sur les principales entreprises mondiales en termes de capitalisation boursière, incluant des indicateurs financiers, des ratios de performance et des scores ESG.

## Variables du jeu de données

### Informations générales

-   **Rank** : Classement de l'entreprise selon sa capitalisation boursière.
-   **Name** : Nom de l'entreprise.
-   **Symbol** : Symbole boursier de l'entreprise.
-   **country** : Pays d'origine de l'entreprise.
-   **sector** : Secteur d'activité (ex : Technologie, Finance, Santé, etc.).
-   **Index** : Indice boursier auquel appartient l'entreprise (ex : S&P 500, Nasdaq).
-   **Continent** : Continent d'implantation de l'entreprise.

### Données de Marché

-   **marketCap** : Capitalisation boursière totale de l'entreprise.
-   **previousClose** : Prix de clôture de l'action lors de la dernière session.
-   **trailingPE** : Ratio prix/bénéfice basé sur les bénéfices passés.
-   **forwardPE** : Ratio prix/bénéfice basé sur les bénéfices estimés.
-   **priceToBook** : Ratio Prix/Valeur comptable.
-   **beta** : Mesure de la volatilité du titre par rapport au marché.

### Performance Financière

-   **profitMargins** : Marge bénéficiaire nette.
-   **enterpriseToRevenue** : Ratio Valeur d'Entreprise/Chiffre d'Affaires.
-   **enterpriseToEbitda** : Ratio Valeur d'Entreprise/EBITDA.
-   **totalRevenue** : Chiffre d'affaires total.
-   **revenuePerShare** : Chiffre d'affaires par action.
-   **revenueGrowth** : Croissance du chiffre d'affaires.
-   **grossMargins** : Marge brute.
-   **ebitdaMargins** : Marge EBITDA.
-   **operatingMargins** : Marge opérationnelle.

### Rentabilité et Gestion Financière

-   **returnOnAssets (ROA)** : Rentabilité des actifs.
-   **returnOnEquity (ROE)** : Rentabilité des fonds propres.
-   **debtToEquity** : Ratio d'endettement.
-   **currentRatio** : Ratio de liquidité courante.
-   **quickRatio** : Ratio de liquidité immédiate.
-   **totalCash** : Montant total des liquidités.
-   **totalDebt** : Montant total des dettes.
-   **bookValue** : Valeur comptable de l'entreprise.

### Dividendes et Rendement Actionnarial

-   **fiveYearAvgDividendYield** : Rendement moyen des dividendes sur 5 ans.
-   **payoutRatio** : Pourcentage des bénéfices distribués en dividendes.
-   **trailingAnnualDividendYield** : Rendement annuel des dividendes.
-   **trailingAnnualDividendRate** : Montant du dividende annuel par action.

### Données ESG (Environnement, Social, Gouvernance)

-   **totalEsg** : Score ESG total.
-   **environmentScore** : Score environnemental.
-   **socialScore** : Score social.
-   **governanceScore** : Score de gouvernance.
-   **ratingYear** : Année de notation ESG.
-   **ratingMonth** : Mois de notation ESG.
-   **highestControversy** : Niveau de controverse maximal associé à l'entreprise.
-   **peerCount** : Nombre d'entreprises comparables pour l'évaluation ESG.
-   **esgPerformance** : Catégorie de performance ESG (ex : LEAD_PERF, AVG_PERF, LAG_PERF).
-   **peerGroup** : Groupe de comparaison sectoriel pour l'ESG.

------------------------------------------------------------------------
